#!/bin/bash

default_pw="123"

function populate() {
	key=$1
	u=0

	while true
	do
		user=$(yq ".$key[$u]" /scripts/users.yaml)
		if [[ $user == 'null' ]]; then return; fi

		username=$(echo "$user" | yq ".username")
		name=$(echo "$user" | yq ".name")

		homedir="/home/$key/$username"

		useradd -m -d "$homedir" -U -c "$name" "$username"
		echo -e "$default_pw\n$default_pw" | passwd --stdin "$username"

		if [[ $key == "users" ]] || [[ $key == "authors" ]]; then
			chmod o+x "$homedir"
		fi

		if [[ $? != 0 ]]; then
			echo "skipping $key $username"
		else
			usermod -a -G "g_$key" "$username"
			if [[ $key == "users" ]]; then
				mkdir "$homedir/all_blogs" "$homedir/subscribed_blogs"
				touch "$homedir/blog_reads.log"
				chown "$username:$username" "$homedir/all_blogs" "$homedir/subscribed_blogs" "$homedir/blog_reads.log"
			elif [[ $key == "authors" ]]; then
				dirs="$homedir/blogs $homedir/public $homedir/subscribers_only"
				mkdir $dirs
				cp "/scripts/blogs_initial.yaml" "$homedir/blogs.yaml"
				chown "$username:$username" $dirs "$homedir/blogs.yaml"
				chmod u=rwx,g=rwx,o=x $dirs
				chmod u=rwx,g=rwx,o= "$homedir/blogs.yaml"
				chmod o+r "$homedir/public"
			fi
			echo "$key $username $name"
		fi

		((u=u+1))
	done
}

populate admins
populate mods
populate authors
populate users
